name: Build WSL2 Kernel for Waydroid
on: 
  push:  # 提交文件自动触发编译
  workflow_dispatch:  # 手动触发编译（更灵活，推荐）

jobs:
  build-kernel:
    runs-on: ubuntu-24.04
    steps:
      # 步骤1：检查仓库（必填，初始化环境）
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 步骤2：安装所有编译依赖（完整无遗漏）
      - name: Install Full Dependencies
        run: |
          sudo apt update -y
          sudo apt install -y build-essential flex bison libssl-dev libelf-dev bc python3 pahole cpio dwarves git --fix-missing

      # 步骤3：克隆WSL2内核源码（6.6.x稳定版，深度克隆加快速度）
      - name: Clone WSL2 Kernel Source Code
        run: |
          git clone --depth=1 -b linux-msft-wsl-6.6.y https://github.com/microsoft/WSL2-Linux-Kernel.git
          cd WSL2-Linux-Kernel
          # 验证Microsoft目录是否存在（容错检查）
          ls -la Microsoft/

      # 步骤4：配置内核（非交互式，直接启用Binder/Ashmem，替代make menuconfig）
      - name: Configure Kernel for Android Support (Non-interactive)
        run: |
          cd WSL2-Linux-Kernel
          # 1. 先加载Microsoft官方WSL配置文件（基础配置）
          cp Microsoft/config-wsl .config
          # 2. 非交互式启用Binder IPC（核心：=y 表示编译进内核，不是模块）
          # Binder核心功能
          scripts/config --enable CONFIG_ANDROID
          scripts/config --enable CONFIG_ANDROID_BINDER_IPC
          scripts/config --enable CONFIG_ANDROID_BINDERFS
          scripts/config --enable CONFIG_ANDROID_BINDER_DEVICES
          # 3. 非交互式启用Ashmem（Android内存共享）
          scripts/config --enable CONFIG_ANDROID_ASHMEM
          # 4. 生成最终配置文件（自动解决依赖冲突）
          make olddefconfig KCONFIG_CONFIG=$(pwd)/.config

      # 步骤5：编译内核（显式指定架构，避免兼容性问题）
      - name: Compile WSL2 Kernel (Enable Binder/Ashmem)
        run: |
          cd WSL2-Linux-Kernel
          # 显式指定x86_64架构，-j$(nproc) 最大化利用CI资源
          make -j$(nproc) KCONFIG_CONFIG=$(pwd)/.config arch/x86_64/boot/bzImage
          # 验证bzImage是否生成（容错检查）
          ls -la arch/x86_64/boot/bzImage

      # 步骤6：上传编译好的内核文件（修复版本冲突，使用稳定v3版本）
      - name: Upload Compiled bzImage
        uses: actions/upload-artifact@v6  # 统一版本，避免冲突
        with:
          name: wsl2-waydroid-kernel
          path: WSL2-Linux-Kernel/arch/x86_64/boot/bzImage
          retention-days: 7  # 文件保存7天，足够下载
