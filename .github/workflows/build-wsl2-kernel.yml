name: Build WSL2 Kernel with Waydroid Support

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # ÂÖÅËÆ∏ÊâãÂä®Ëß¶Âèë
    inputs:
      kernel_version:
        description: 'Linux kernel version (ÂèØÈÄâ)'
        required: false
        default: ''
      microsoft_branch:
        description: 'Microsoft WSL2 kernel branch'
        required: false
        default: ''
  schedule:
    # ÊØèÂë®‰∏Ä 00:00 UTC Ëá™Âä®ËøêË°å
    - cron: '0 0 * * 1'
  repository_dispatch:
    types: [build-kernel]

env:
  WORKSPACE: ${{ github.workspace }}

jobs:
  get-kernel-info:
    runs-on: ubuntu-24.04
    outputs:
      latest_tag: ${{ steps.get-latest-tag.outputs.tag }}
      kernel_version: ${{ steps.parse-version.outputs.version }}
    steps:
    - name: Get latest kernel tag
      id: get-latest-tag
      run: |
        # Ëé∑Âèñ Microsoft WSL2 ÂÜÖÊ†∏ÁöÑÊúÄÊñ∞Ê†áÁ≠æ
        LATEST_TAG=$(curl -s "https://api.github.com/repos/microsoft/WSL2-Linux-Kernel/tags?per_page=5" | jq -r '.[0].name // "null"')
        if [ "$LATEST_TAG" = "null" ] || [ -z "$LATEST_TAG" ]; then
          LATEST_TAG="linux-msft-wsl-6.6.30"
        fi
        echo "tag=$LATEST_TAG" >> $GITHUB_OUTPUT
        echo "Latest kernel tag: $LATEST_TAG"
    
    - name: Parse kernel version
      id: parse-version
      run: |
        TAG="${{ steps.get-latest-tag.outputs.tag }}"
        echo "Tag: $TAG"
        
        if [ -z "$TAG" ] || [ "$TAG" = "null" ]; then
          KERNEL_VERSION="6.6.30"
        else
          # ‰ªéÊ†áÁ≠æ‰∏≠ÊèêÂèñÁâàÊú¨Âè∑
          KERNEL_VERSION=$(echo "$TAG" | sed -E 's/^linux-msft-wsl-//' | sed -E 's/[-_]wsl.*$//' | sed -E 's/^v//')
        fi
        
        # È™åËØÅÁâàÊú¨Âè∑Ê†ºÂºè
        if ! echo "$KERNEL_VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+'; then
          echo "Warning: Invalid version format '$KERNEL_VERSION', using default"
          KERNEL_VERSION="6.6.30"
        fi
        
        echo "version=$KERNEL_VERSION" >> $GITHUB_OUTPUT
        echo "Parsed kernel version: $KERNEL_VERSION"

  build-kernel:
    needs: get-kernel-info
    runs-on: ubuntu-24.04
    timeout-minutes: 120
    env:
      KERNEL_SRC_DIR: "${{ github.workspace }}/WSL2-Linux-Kernel"
      OUTPUT_DIR: "${{ github.workspace }}/kernel-output"
    
    steps:
    - name: Checkout this repository
      uses: actions/checkout@v4
    
    - name: Set up build environment
      run: |
        echo "Setting up build environment..."
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
          build-essential \
          flex \
          bison \
          libssl-dev \
          libelf-dev \
          bc \
          dwarves \
          git \
          wget \
          curl \
          cpio \
          rsync \
          kmod \
          pkg-config \
          libncurses-dev \
          zstd \
          jq \
          python3 \
          python3-pip
        
        # ÂÆâË£Ö python ‰æùËµñ
        pip3 install --upgrade pip
        
        echo "Build environment setup completed"
    
    - name: Set build variables
      id: set-vars
      run: |
        # ËÆæÁΩÆÊûÑÂª∫Êó•Êúü
        BUILD_DATE=$(date +%Y%m%d-%H%M%S)
        echo "BUILD_DATE=$BUILD_DATE" >> $GITHUB_ENV
        
        # Á°ÆÂÆöÂÜÖÊ†∏ÁâàÊú¨
        if [ -n "${{ github.event.inputs.kernel_version }}" ] && [ "${{ github.event.inputs.kernel_version }}" != "" ]; then
          KERNEL_VERSION="${{ github.event.inputs.kernel_version }}"
          echo "Using manual input version: $KERNEL_VERSION"
        elif [ -n "${{ needs.get-kernel-info.outputs.kernel_version }}" ] && [ "${{ needs.get-kernel-info.outputs.kernel_version }}" != "" ]; then
          KERNEL_VERSION="${{ needs.get-kernel-info.outputs.kernel_version }}"
          echo "Using auto-detected version: $KERNEL_VERSION"
        else
          KERNEL_VERSION="6.6.30"
          echo "Using default version: $KERNEL_VERSION"
        fi
        
        # È™åËØÅÂÜÖÊ†∏ÁâàÊú¨Ê†ºÂºè
        if ! echo "$KERNEL_VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+'; then
          echo "Error: Invalid kernel version format: $KERNEL_VERSION"
          exit 1
        fi
        
        echo "KERNEL_VERSION=$KERNEL_VERSION" >> $GITHUB_ENV
        
        # Á°ÆÂÆöÂàÜÊîØ
        if [ -n "${{ github.event.inputs.microsoft_branch }}" ] && [ "${{ github.event.inputs.microsoft_branch }}" != "" ]; then
          MS_BRANCH="${{ github.event.inputs.microsoft_branch }}"
        else
          # ‰ªéÁâàÊú¨Âè∑Êé®Êñ≠ÂàÜÊîØ
          MAJOR_VERSION=$(echo "$KERNEL_VERSION" | cut -d. -f1,2)
          MS_BRANCH="linux-msft-wsl-${MAJOR_VERSION}.y"
        fi
        
        echo "MS_BRANCH=$MS_BRANCH" >> $GITHUB_ENV
        
        echo "Build Variables:"
        echo "  Kernel Version: $KERNEL_VERSION"
        echo "  MS Branch: $MS_BRANCH"
        echo "  Build Date: $BUILD_DATE"
        echo "  Workspace: ${{ github.workspace }}"
        echo "  Kernel Source Dir: $KERNEL_SRC_DIR"
        echo "  Output Dir: $OUTPUT_DIR"
    
    - name: Download WSL2 kernel source
      env:
        KERNEL_VERSION: ${{ env.KERNEL_VERSION }}
        MS_BRANCH: ${{ env.MS_BRANCH }}
        BUILD_DATE: ${{ env.BUILD_DATE }}
      run: |
        echo "=============================================="
        echo "Building WSL2 Kernel with Waydroid Support"
        echo "Kernel version: $KERNEL_VERSION"
        echo "Microsoft branch: $MS_BRANCH"
        echo "Build date: $BUILD_DATE"
        echo "Triggered by: ${{ github.event_name }}"
        echo "=============================================="
        
        # ÂàõÂª∫ÁõÆÂΩï
        mkdir -p "$KERNEL_SRC_DIR"
        cd "${{ github.workspace }}"
        
        # ÂÖãÈöÜ Microsoft ÁöÑ WSL2 ÂÜÖÊ†∏‰ªìÂ∫ì
        echo "Cloning WSL2 kernel repository (branch: $MS_BRANCH)..."
        
        if git clone --depth 1 --branch "$MS_BRANCH" \
          https://github.com/microsoft/WSL2-Linux-Kernel.git "$KERNEL_SRC_DIR"; then
          echo "Successfully cloned branch: $MS_BRANCH"
        else
          echo "Failed to clone branch $MS_BRANCH, trying default branch..."
          rm -rf "$KERNEL_SRC_DIR"
          git clone --depth 1 \
            https://github.com/microsoft/WSL2-Linux-Kernel.git "$KERNEL_SRC_DIR"
        fi
        
        cd "$KERNEL_SRC_DIR"
        KERNEL_COMMIT=$(git rev-parse --short HEAD)
        KERNEL_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "unknown")
        
        echo "KERNEL_COMMIT=$KERNEL_COMMIT" >> $GITHUB_ENV
        echo "KERNEL_TAG=$KERNEL_TAG" >> $GITHUB_ENV
        echo "KERNEL_SRC_DIR=$(pwd)" >> $GITHUB_ENV
        
        echo "Kernel source directory: $(pwd)"
        echo "Kernel commit: $KERNEL_COMMIT"
        echo "Kernel tag: $KERNEL_TAG"
        echo "Files in kernel source:"
        ls -la
    
    - name: Apply Waydroid kernel patches
      env:
        KERNEL_SRC_DIR: ${{ env.KERNEL_SRC_DIR }}
      run: |
        echo "Applying Waydroid kernel patches..."
        cd "$KERNEL_SRC_DIR"
        
        # Ê£ÄÊü•Âπ∂ÈÄâÊã©Âü∫Á°ÄÈÖçÁΩÆ
        if [ -f "Microsoft/config-wsl" ]; then
          echo "Using Microsoft/config-wsl as base configuration"
          cp Microsoft/config-wsl .config
        elif [ -f "Microsoft/config" ]; then
          echo "Using Microsoft/config as base configuration"
          cp Microsoft/config .config
        elif [ -f "arch/x86/configs/config-wsl" ]; then
          echo "Using arch/x86/configs/config-wsl as base configuration"
          cp arch/x86/configs/config-wsl .config
        else
          echo "No preset config found, generating x86_64 defconfig"
          make x86_64_defconfig
        fi
        
        echo "Base configuration copied"
        echo "Config file size: $(wc -l < .config) lines"
        
        # ÂàõÂª∫ÈÖçÁΩÆËÑöÊú¨
        cat > apply_waydroid_config.sh << 'EOF'
        #!/bin/bash
        set -e
        
        echo "=== Applying Waydroid kernel configuration ==="
        
        # Ê£ÄÊü• scripts/config ÊòØÂê¶Â≠òÂú®
        if [ ! -f "scripts/config" ]; then
          echo "Building scripts/config..."
          make scripts_basic
        fi
        
        echo "1. Enabling Android Binder support..."
        if ./scripts/config --enable CONFIG_ANDROID; then echo "  ‚úì CONFIG_ANDROID"; else echo "  ‚úó CONFIG_ANDROID"; fi
        if ./scripts/config --enable CONFIG_ANDROID_BINDER_IPC; then echo "  ‚úì CONFIG_ANDROID_BINDER_IPC"; else echo "  ‚úó CONFIG_ANDROID_BINDER_IPC"; fi
        if ./scripts/config --enable CONFIG_ANDROID_BINDERFS; then echo "  ‚úì CONFIG_ANDROID_BINDERFS"; else echo "  ‚úó CONFIG_ANDROID_BINDERFS"; fi
        if ./scripts/config --set-val CONFIG_ANDROID_BINDER_DEVICES "binder,hwbinder,vndbinder"; then echo "  ‚úì CONFIG_ANDROID_BINDER_DEVICES"; else echo "  ‚úó CONFIG_ANDROID_BINDER_DEVICES"; fi
        
        echo "2. Enabling ASHMEM..."
        if ./scripts/config --enable CONFIG_ASHMEM; then echo "  ‚úì CONFIG_ASHMEM"; else echo "  ‚úó CONFIG_ASHMEM"; fi
        
        echo "3. Enabling network support..."
        if ./scripts/config --enable CONFIG_BRIDGE; then echo "  ‚úì CONFIG_BRIDGE"; else echo "  ‚úó CONFIG_BRIDGE"; fi
        if ./scripts/config --enable CONFIG_BRIDGE_NETFILTER; then echo "  ‚úì CONFIG_BRIDGE_NETFILTER"; else echo "  ‚úó CONFIG_BRIDGE_NETFILTER"; fi
        if ./scripts/config --enable CONFIG_NETFILTER_XT_MATCH_PHYSDEV; then echo "  ‚úì CONFIG_NETFILTER_XT_MATCH_PHYSDEV"; else echo "  ‚úó CONFIG_NETFILTER_XT_MATCH_PHYSDEV"; fi
        if ./scripts/config --enable CONFIG_NETFILTER_XT_CONNMARK; then echo "  ‚úì CONFIG_NETFILTER_XT_CONNMARK"; else echo "  ‚úó CONFIG_NETFILTER_XT_CONNMARK"; fi
        if ./scripts/config --enable CONFIG_NETFILTER_XT_MARK; then echo "  ‚úì CONFIG_NETFILTER_XT_MARK"; else echo "  ‚úó CONFIG_NETFILTER_XT_MARK"; fi
        
        echo "4. Enabling user namespaces..."
        if ./scripts/config --enable CONFIG_USER_NS; then echo "  ‚úì CONFIG_USER_NS"; else echo "  ‚úó CONFIG_USER_NS"; fi
        if ./scripts/config --enable CONFIG_PID_NS; then echo "  ‚úì CONFIG_PID_NS"; else echo "  ‚úó CONFIG_PID_NS"; fi
        if ./scripts/config --enable CONFIG_NET_NS; then echo "  ‚úì CONFIG_NET_NS"; else echo "  ‚úó CONFIG_NET_NS"; fi
        if ./scripts/config --enable CONFIG_UTS_NS; then echo "  ‚úì CONFIG_UTS_NS"; else echo "  ‚úó CONFIG_UTS_NS"; fi
        if ./scripts/config --enable CONFIG_IPC_NS; then echo "  ‚úì CONFIG_IPC_NS"; else echo "  ‚úó CONFIG_IPC_NS"; fi
        
        echo "5. Enabling security features..."
        if ./scripts/config --enable CONFIG_SECCOMP; then echo "  ‚úì CONFIG_SECCOMP"; else echo "  ‚úó CONFIG_SECCOMP"; fi
        if ./scripts/config --enable CONFIG_SECCOMP_FILTER; then echo "  ‚úì CONFIG_SECCOMP_FILTER"; else echo "  ‚úó CONFIG_SECCOMP_FILTER"; fi
        
        echo "6. Enabling cgroups..."
        if ./scripts/config --enable CONFIG_CGROUPS; then echo "  ‚úì CONFIG_CGROUPS"; else echo "  ‚úó CONFIG_CGROUPS"; fi
        if ./scripts/config --enable CONFIG_CGROUP_DEVICE; then echo "  ‚úì CONFIG_CGROUP_DEVICE"; else echo "  ‚úó CONFIG_CGROUP_DEVICE"; fi
        if ./scripts/config --enable CONFIG_CGROUP_FREEZER; then echo "  ‚úì CONFIG_CGROUP_FREEZER"; else echo "  ‚úó CONFIG_CGROUP_FREEZER"; fi
        if ./scripts/config --enable CONFIG_CGROUP_PIDS; then echo "  ‚úì CONFIG_CGROUP_PIDS"; else echo "  ‚úó CONFIG_CGROUP_PIDS"; fi
        if ./scripts/config --enable CONFIG_CGROUP_CPUACCT; then echo "  ‚úì CONFIG_CGROUP_CPUACCT"; else echo "  ‚úó CONFIG_CGROUP_CPUACCT"; fi
        if ./scripts/config --enable CONFIG_CGROUP_SCHED; then echo "  ‚úì CONFIG_CGROUP_SCHED"; else echo "  ‚úó CONFIG_CGROUP_SCHED"; fi
        
        echo "7. Enabling network filtering..."
        if ./scripts/config --enable CONFIG_IP_NF_IPTABLES; then echo "  ‚úì CONFIG_IP_NF_IPTABLES"; else echo "  ‚úó CONFIG_IP_NF_IPTABLES"; fi
        if ./scripts/config --enable CONFIG_IP_NF_NAT; then echo "  ‚úì CONFIG_IP_NF_NAT"; else echo "  ‚úó CONFIG_IP_NF_NAT"; fi
        if ./scripts/config --enable CONFIG_IP_NF_FILTER; then echo "  ‚úì CONFIG_IP_NF_FILTER"; else echo "  ‚úó CONFIG_IP_NF_FILTER"; fi
        if ./scripts/config --enable CONFIG_IP_NF_MANGLE; then echo "  ‚úì CONFIG_IP_NF_MANGLE"; else echo "  ‚úó CONFIG_IP_NF_MANGLE"; fi
        if ./scripts/config --enable CONFIG_NETFILTER_XTABLES; then echo "  ‚úì CONFIG_NETFILTER_XTABLES"; else echo "  ‚úó CONFIG_NETFILTER_XTABLES"; fi
        
        echo "8. Enabling additional features for Waydroid..."
        if ./scripts/config --enable CONFIG_INET; then echo "  ‚úì CONFIG_INET"; else echo "  ‚úó CONFIG_INET"; fi
        if ./scripts/config --enable CONFIG_NET; then echo "  ‚úì CONFIG_NET"; else echo "  ‚úó CONFIG_NET"; fi
        if ./scripts/config --enable CONFIG_INET_UDP_DIAG; then echo "  ‚úì CONFIG_INET_UDP_DIAG"; else echo "  ‚úó CONFIG_INET_UDP_DIAG"; fi
        if ./scripts/config --enable CONFIG_PACKET_DIAG; then echo "  ‚úì CONFIG_PACKET_DIAG"; else echo "  ‚úó CONFIG_PACKET_DIAG"; fi
        if ./scripts/config --enable CONFIG_UNIX_DIAG; then echo "  ‚úì CONFIG_UNIX_DIAG"; else echo "  ‚úó CONFIG_UNIX_DIAG"; fi
        
        echo "9. Disabling debug info to reduce size..."
        if ./scripts/config --disable CONFIG_DEBUG_INFO; then echo "  ‚úì CONFIG_DEBUG_INFO (disabled)"; else echo "  ‚úó CONFIG_DEBUG_INFO"; fi
        if ./scripts/config --disable CONFIG_DEBUG_INFO_BTF; then echo "  ‚úì CONFIG_DEBUG_INFO_BTF (disabled)"; else echo "  ‚úó CONFIG_DEBUG_INFO_BTF"; fi
        
        echo "=== Configuration completed ==="
        EOF
        
        chmod +x apply_waydroid_config.sh
        
        # Â∫îÁî®ÈÖçÁΩÆ
        echo "Applying configuration changes..."
        if ./apply_waydroid_config.sh; then
          echo "Configuration script executed successfully"
        else
          echo "Warning: Some configuration options may not be available"
        fi
        
        # È™åËØÅÈÖçÁΩÆ
        echo ""
        echo "Configuration summary:"
        echo "========================================"
        echo "CONFIG_ANDROID=$(grep -c "^CONFIG_ANDROID=y" .config || echo "not set")"
        echo "CONFIG_ANDROID_BINDER_IPC=$(grep -c "^CONFIG_ANDROID_BINDER_IPC=y" .config || echo "not set")"
        echo "CONFIG_ASHMEM=$(grep -c "^CONFIG_ASHMEM=y" .config || echo "not set")"
        echo "CONFIG_USER_NS=$(grep -c "^CONFIG_USER_NS=y" .config || echo "not set")"
        echo "CONFIG_CGROUPS=$(grep -c "^CONFIG_CGROUPS=y" .config || echo "not set")"
        echo "========================================"
    
    - name: Configure kernel
      env:
        KERNEL_SRC_DIR: ${{ env.KERNEL_SRC_DIR }}
      run: |
        cd "$KERNEL_SRC_DIR"
        echo "Configuring kernel..."
        echo "Current directory: $(pwd)"
        echo "Config file: $(ls -la .config 2>/dev/null || echo 'Not found')"
        
        # ‰ΩøÁî®Áé∞ÊúâÈÖçÁΩÆÔºåÂ∫îÁî®Êñ∞ÈÖçÁΩÆ
        echo "Running make olddefconfig..."
        if make olddefconfig; then
          echo "Configuration completed successfully"
        else
          echo "Warning: make olddefconfig failed, trying oldconfig..."
          make oldconfig
        fi
        
        echo ""
        echo "Final configuration check:"
        echo "========================================"
        echo "Essential Waydroid configurations:"
        grep -E "^(CONFIG_ANDROID|CONFIG_ANDROID_BINDER_IPC|CONFIG_ASHMEM|CONFIG_USER_NS|CONFIG_CGROUPS)=" .config 2>/dev/null || echo "Not found in config"
        echo "========================================"
    
    - name: Build kernel
      env:
        KERNEL_SRC_DIR: ${{ env.KERNEL_SRC_DIR }}
      run: |
        cd "$KERNEL_SRC_DIR"
        NPROC=$(nproc)
        echo "Building kernel with $NPROC threads..."
        echo "This may take 30-60 minutes..."
        echo "Current directory: $(pwd)"
        echo "Available space:"
        df -h .
        
        # ÁºñËØëÂÜÖÊ†∏
        echo "Starting kernel build..."
        
        # Ê£ÄÊü•ÊòØÂê¶Â∑≤Êúâ .config
        if [ ! -f ".config" ]; then
          echo "Error: .config not found!"
          exit 1
        fi
        
        # ÂºÄÂßãÊûÑÂª∫
        if make -j$NPROC 2>&1 | tee build.log; then
          echo "‚úÖ Kernel build successful!"
          
          # Ê£ÄÊü•ÂÜÖÊ†∏Êñá‰ª∂
          if [ -f "arch/x86/boot/bzImage" ]; then
            KERNEL_SIZE=$(ls -lh arch/x86/boot/bzImage | awk '{print $5}')
            echo "Kernel file created: arch/x86/boot/bzImage"
            echo "Kernel size: $KERNEL_SIZE"
            
            # ÁºñËØëÊ®°Âùó
            echo "Building modules..."
            if make modules -j$NPROC 2>&1 | tee modules.log; then
              echo "‚úÖ Modules build successful!"
              echo "KERNEL_BUILD_STATUS=success" >> $GITHUB_ENV
            else
              echo "‚ö†Ô∏è Modules build had warnings"
              echo "KERNEL_BUILD_STATUS=success" >> $GITHUB_ENV
            fi
          else
            echo "‚ùå Kernel file not found!"
            echo "KERNEL_BUILD_STATUS=failed" >> $GITHUB_ENV
            echo "Build log tail:"
            tail -50 build.log
            exit 1
          fi
        else
          echo "‚ùå Kernel build failed!"
          echo "KERNEL_BUILD_STATUS=failed" >> $GITHUB_ENV
          echo "Build log tail:"
          tail -50 build.log
          exit 1
        fi
        
        echo "Build logs:"
        echo "========== build.log =========="
        tail -20 build.log
        echo "========== modules.log =========="
        tail -20 modules.log
    
    - name: Install modules
      env:
        KERNEL_SRC_DIR: ${{ env.KERNEL_SRC_DIR }}
      run: |
        cd "$KERNEL_SRC_DIR"
        
        if [ ! -f "arch/x86/boot/bzImage" ]; then
          echo "‚ùå Kernel not built, skipping module installation"
          exit 1
        fi
        
        echo "Installing modules..."
        echo "Current directory: $(pwd)"
        
        # ÂàõÂª∫‰∏¥Êó∂ÁõÆÂΩïÂÆâË£ÖÊ®°Âùó
        mkdir -p kernel-modules
        echo "Installing modules to kernel-modules/"
        
        if make modules_install INSTALL_MOD_PATH=$(pwd)/kernel-modules 2>&1 | tee modules_install.log; then
          echo "‚úÖ Modules installed successfully"
          
          # Ê£ÄÊü•ÂÆâË£ÖÁöÑÊ®°Âùó
          MODULE_COUNT=$(find kernel-modules -name "*.ko" 2>/dev/null | wc -l || echo 0)
          echo "Installed $MODULE_COUNT modules"
          
          if [ $MODULE_COUNT -eq 0 ]; then
            echo "‚ö†Ô∏è Warning: No modules installed"
            echo "MODULE_COUNT=0" >> $GITHUB_ENV
          else
            echo "MODULE_COUNT=$MODULE_COUNT" >> $GITHUB_ENV
            echo "Module directories:"
            find kernel-modules -type d | head -10
          fi
        else
          echo "‚ùå Module installation failed"
          echo "MODULE_COUNT=0" >> $GITHUB_ENV
        fi
    
    - name: Create kernel package
      env:
        KERNEL_SRC_DIR: ${{ env.KERNEL_SRC_DIR }}
        OUTPUT_DIR: ${{ env.OUTPUT_DIR }}
        BUILD_DATE: ${{ env.BUILD_DATE }}
        KERNEL_COMMIT: ${{ env.KERNEL_COMMIT }}
        KERNEL_TAG: ${{ env.KERNEL_TAG }}
        KERNEL_VERSION: ${{ env.KERNEL_VERSION }}
        MODULE_COUNT: ${{ env.MODULE_COUNT }}
      run: |
        echo "Creating kernel package..."
        echo "KERNEL_SRC_DIR: $KERNEL_SRC_DIR"
        echo "OUTPUT_DIR: $OUTPUT_DIR"
        echo "Current directory: $(pwd)"
        
        if [ ! -f "$KERNEL_SRC_DIR/arch/x86/boot/bzImage" ]; then
          echo "‚ùå Kernel not built, skipping packaging"
          exit 1
        fi
        
        # ÂàõÂª∫ËæìÂá∫ÁõÆÂΩï
        mkdir -p "$OUTPUT_DIR"
        echo "Output directory created: $OUTPUT_DIR"
        
        # Ëé∑ÂèñÂÜÖÊ†∏ÁâàÊú¨
        cd "$KERNEL_SRC_DIR"
        KERNEL_RELEASE=$(make kernelrelease 2>/dev/null || echo "$KERNEL_VERSION-waydroid")
        echo "KERNEL_RELEASE=$KERNEL_RELEASE" >> $GITHUB_ENV
        
        # Â§çÂà∂ÂÜÖÊ†∏Êò†ÂÉè
        KERNEL_FILE="bzImage-waydroid-$KERNEL_VERSION"
        cp "arch/x86/boot/bzImage" "$OUTPUT_DIR/$KERNEL_FILE"
        echo "Kernel copied: $OUTPUT_DIR/$KERNEL_FILE"
        
        # ÂàõÂª∫ÁâàÊú¨‰ø°ÊÅØÊñá‰ª∂
        cat > "$OUTPUT_DIR/version-info.txt" << EOF
========================================
WSL2 Kernel with Waydroid Support
========================================

Build Information:
------------------
Kernel Version: $KERNEL_VERSION
Kernel Release: $KERNEL_RELEASE
Git Commit: $KERNEL_COMMIT
Git Tag: $KERNEL_TAG
Build Date: $(date -u)
Build ID: $BUILD_DATE
Trigger: ${{ github.event_name }}
Modules: ${MODULE_COUNT:-0}
Source: https://github.com/microsoft/WSL2-Linux-Kernel

Features Enabled:
-----------------
‚úì Android Binder IPC
‚úì ASHMEM shared memory
‚úì User namespaces
‚úì Network namespaces
‚úì Bridge networking
‚úì Cgroups support
‚úì Security features
‚úì Netfilter/IPtables

Installation:
-------------
1. Copy '$KERNEL_FILE' to a Windows directory
2. Update your '%USERPROFILE%\\.wslconfig' file:

   [wsl2]
   kernel=C:\\path\\to\\$KERNEL_FILE
   memory=4GB
   processors=2

3. Restart WSL: wsl --shutdown
4. Start WSL again

Waydroid Setup:
---------------
# In WSL2 Ubuntu:
curl https://repo.waydro.id | sudo bash
sudo apt update
sudo apt install waydroid
sudo waydroid init
systemctl --user start waydroid-container
waydroid session start
========================================
EOF
        
        echo "Version info created: $OUTPUT_DIR/version-info.txt"
        
        # ÁîüÊàê .wslconfig
        cat > "$OUTPUT_DIR/.wslconfig" << EOF
[wsl2]
kernel=C:\\Users\\YourUsername\\wsl2-kernel\\$KERNEL_FILE
memory=4GB
processors=2
localhostForwarding=true

# Waydroid optimized settings
[experimental]
autoMemoryReclaim=gradual
networkingMode=mirrored
dnsTunneling=true
firewall=false
hostAddressLoopback=true
EOF
        
        echo "WSL config created: $OUTPUT_DIR/.wslconfig"
        
        # ÂàõÂª∫ÂÆâË£ÖËÑöÊú¨
        cat > "$OUTPUT_DIR/install.sh" << 'EOF'
#!/bin/bash
# WSL2 Waydroid Kernel Installer

set -e

echo "========================================"
echo "WSL2 Waydroid Kernel Installation Script"
echo "========================================"

# Find kernel file
KERNEL_FILE=$(ls bzImage-waydroid-*.bzImage 2>/dev/null | head -1)
if [ -z "$KERNEL_FILE" ]; then
    KERNEL_FILE=$(ls bzImage-waydroid-* 2>/dev/null | head -1)
fi

if [ -z "$KERNEL_FILE" ] || [ ! -f "$KERNEL_FILE" ]; then
    echo "Error: Kernel file not found!"
    echo "Please place this script in the same directory as the kernel file."
    echo "Available files:"
    ls -la
    exit 1
fi

echo "Found kernel: $KERNEL_FILE"

# Get Windows username
if command -v cmd.exe &> /dev/null; then
    USERNAME=$(cmd.exe /c "echo %USERNAME%" 2>/dev/null | tr -d '\r')
else
    echo "Enter your Windows username:"
    read USERNAME
fi

echo "Windows username: $USERNAME"
echo ""

# Create directory in Windows
WINDOWS_DIR="/mnt/c/Users/$USERNAME/wsl2-kernel"
echo "Creating kernel directory: $WINDOWS_DIR"
mkdir -p "$WINDOWS_DIR"

# Copy kernel to Windows
echo "Copying kernel to Windows..."
cp "$KERNEL_FILE" "$WINDOWS_DIR/"

# Create .wslconfig
WSL_CONFIG="/mnt/c/Users/$USERNAME/.wslconfig"
echo "Creating .wslconfig: $WSL_CONFIG"

cat > /tmp/.wslconfig << CONFIG
[wsl2]
kernel=C:\\Users\\$USERNAME\\wsl2-kernel\\$KERNEL_FILE
memory=4GB
processors=2
localhostForwarding=true

[experimental]
autoMemoryReclaim=gradual
networkingMode=mirrored
dnsTunneling=true
firewall=false
hostAddressLoopback=true
CONFIG

cp /tmp/.wslconfig "$WSL_CONFIG"

echo ""
echo "========================================"
echo "‚úÖ Installation complete!"
echo "========================================"
echo ""
echo "To apply the new kernel:"
echo "1. Close all WSL2 terminals and applications"
echo "2. Open PowerShell or CMD as Administrator"
echo "3. Run: wsl --shutdown"
echo "4. Restart your WSL2 distribution"
echo ""
echo "To verify the new kernel:"
echo "  wsl cat /proc/version"
echo "  uname -a"
echo ""
echo "To check Waydroid support:"
echo "  grep binder /proc/filesystems"
echo "  lsmod | grep binder"
echo ""
echo "Troubleshooting:"
echo "- If WSL doesn't start: check .wslconfig syntax"
echo "- If binder not found: ensure kernel has binder support"
echo "- For Waydroid issues: check systemd and user namespaces"
echo "========================================"
EOF
        
        chmod +x "$OUTPUT_DIR/install.sh"
        echo "Install script created: $OUTPUT_DIR/install.sh"
        
        # ÊâìÂåÖÊ®°Âùó
        if [ -d "$KERNEL_SRC_DIR/kernel-modules" ] && [ "${MODULE_COUNT:-0}" -gt 0 ]; then
          echo "Packing ${MODULE_COUNT} modules..."
          tar -czf "$OUTPUT_DIR/modules-$KERNEL_VERSION.tar.gz" -C "$KERNEL_SRC_DIR/kernel-modules" lib/modules
          echo "Modules packed: $OUTPUT_DIR/modules-$KERNEL_VERSION.tar.gz"
        else
          echo "No modules to pack"
        fi
        
        # ÂàõÂª∫ÂéãÁº©ÂåÖ
        cd "${{ github.workspace }}"
        tar -czf "wsl2-waydroid-kernel-$KERNEL_VERSION-$BUILD_DATE.tar.gz" -C "kernel-output" .
        
        echo "Package created: wsl2-waydroid-kernel-$KERNEL_VERSION-$BUILD_DATE.tar.gz"
        echo "Output directory contents:"
        ls -la "$OUTPUT_DIR/"
        
        # È™åËØÅÊñá‰ª∂
        echo "Verifying files..."
        if [ -f "wsl2-waydroid-kernel-$KERNEL_VERSION-$BUILD_DATE.tar.gz" ]; then
          echo "‚úÖ Package created successfully"
          echo "Package size: $(du -h wsl2-waydroid-kernel-$KERNEL_VERSION-$BUILD_DATE.tar.gz | cut -f1)"
        else
          echo "‚ùå Package creation failed"
          exit 1
        fi
    
    - name: Upload artifacts
      if: env.KERNEL_BUILD_STATUS == 'success'
      uses: actions/upload-artifact@v4
      with:
        name: wsl2-waydroid-kernel-${{ env.KERNEL_VERSION }}-${{ env.BUILD_DATE }}
        path: |
          ${{ env.OUTPUT_DIR }}
          wsl2-waydroid-kernel-${{ env.KERNEL_VERSION }}-${{ env.BUILD_DATE }}.tar.gz
        retention-days: 30
        if-no-files-found: error
    
    - name: Create GitHub Release
      if: (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch') && env.KERNEL_BUILD_STATUS == 'success'
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: wsl2-waydroid-${{ env.KERNEL_VERSION }}-${{ env.BUILD_DATE }}
        name: WSL2 Waydroid Kernel ${{ env.KERNEL_VERSION }} (${{ env.BUILD_DATE }})
        body: |
          # WSL2 Kernel with Waydroid Support
          
          ## üì¶ Build Information
          - **Kernel Version**: ${{ env.KERNEL_VERSION }}
          - **Git Commit**: [${{ env.KERNEL_COMMIT }}](https://github.com/microsoft/WSL2-Linux-Kernel/commit/${{ env.KERNEL_COMMIT }})
          - **Git Tag**: ${{ env.KERNEL_TAG }}
          - **Build Date**: ${{ env.BUILD_DATE }}
          - **Modules**: ${{ env.MODULE_COUNT || '0' }}
          
          ## ‚úÖ Features
          - Android Binder IPC
          - ASHMEM support
          - User namespaces
          - Network bridge
          - Cgroups
          - Security features
          - Netfilter/IPtables
          
          ## üöÄ Quick Installation
          1. Download the package
          2. Extract files
          3. Run: `chmod +x install.sh && ./install.sh`
          4. Restart WSL: `wsl --shutdown`
          
          ## üîß Waydroid Setup
