name: build-wsl2-kernel.yml

on:
  push:
    branches: [ main, master ]
    paths:
      - '.github/workflows/build-wsl2-waydroid-kernel.yml'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # 允许手动触发
    inputs:
      kernel_version:
        description: 'Linux kernel version (e.g., 6.6.30)'
        required: true
        default: '6.6.30'
      microsoft_branch:
        description: 'Microsoft WSL2 kernel branch'
        required: true
        default: 'linux-msft-wsl-6.6.y'

jobs:
  build-kernel:
    runs-on: ubuntu-24.04
    timeout-minutes: 120  # 编译内核可能需要较长时间
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          flex \
          bison \
          libssl-dev \
          libelf-dev \
          bc \
          dwarves \
          git \
          wget \
          curl \
          cpio \
          rsync \
          kmod \
          pkg-config \
          libncurses-dev \
          zstd
        echo "Build environment setup completed"
    
    - name: Download WSL2 kernel source
      env:
        KERNEL_VERSION: ${{ github.event.inputs.kernel_version || '6.6.30' }}
        MS_BRANCH: ${{ github.event.inputs.microsoft_branch || 'linux-msft-wsl-6.6.y' }}
      run: |
        echo "Downloading WSL2 kernel source for version: $KERNEL_VERSION"
        echo "Using Microsoft branch: $MS_BRANCH"
        
        # 克隆 Microsoft 的 WSL2 内核仓库
        git clone --depth 1 --branch $MS_BRANCH \
          https://github.com/microsoft/WSL2-Linux-Kernel.git
        
        cd WSL2-Linux-Kernel
        KERNEL_COMMIT=$(git rev-parse HEAD)
        echo "KERNEL_COMMIT=$KERNEL_COMMIT" >> $GITHUB_ENV
        echo "KERNEL_SOURCE_DIR=$(pwd)" >> $GITHUB_ENV
        cd ..
    
    - name: Apply Waydroid kernel patches
      env:
        KERNEL_SOURCE_DIR: ${{ env.KERNEL_SOURCE_DIR }}
      run: |
        echo "Applying Waydroid kernel patches..."
        cd $KERNEL_SOURCE_DIR
        
        # Waydroid 需要的内核配置
        # 1. 确保 binder 驱动启用
        # 2. 启用 android 相关配置
        # 3. 启用必要的网络和 security 配置
        
        # 备份原始配置
        cp Microsoft/config-wsl .config
        
        # 启用 binder
        scripts/config --enable CONFIG_ANDROID
        scripts/config --enable CONFIG_ANDROID_BINDER_IPC
        scripts/config --enable CONFIG_ANDROID_BINDERFS
        scripts/config --set-val CONFIG_ANDROID_BINDER_DEVICES "binder,hwbinder,vndbinder"
        
        # 启用必要的 ASHMEM
        scripts/config --enable CONFIG_ASHMEM
        
        # 启用网络配置（Waydroid 需要）
        scripts/config --enable CONFIG_BRIDGE
        scripts/config --enable CONFIG_BRIDGE_NETFILTER
        scripts/config --enable CONFIG_NETFILTER_XT_MATCH_PHYSDEV
        scripts/config --enable CONFIG_NETFILTER_XT_CONNMARK
        scripts/config --enable CONFIG_NETFILTER_XT_MARK
        
        # 启用必要的安全配置
        scripts/config --enable CONFIG_SECCOMP
        scripts/config --enable CONFIG_SECCOMP_FILTER
        
        # 启用用户命名空间
        scripts/config --enable CONFIG_USER_NS
        scripts/config --enable CONFIG_PID_NS
        scripts/config --enable CONFIG_NET_NS
        scripts/config --enable CONFIG_IPC_NS
        scripts/config --enable CONFIG_UTS_NS
        
        # 启用 cgroup 配置
        scripts/config --enable CONFIG_CGROUPS
        scripts/config --enable CONFIG_CGROUP_DEVICE
        scripts/config --enable CONFIG_CGROUP_FREEZER
        scripts/config --enable CONFIG_CGROUP_PIDS
        scripts/config --enable CONFIG_CGROUP_CPUACCT
        scripts/config --enable CONFIG_CGROUP_SCHED
        
        # 启用网络配置
        scripts/config --enable CONFIG_IP_NF_IPTABLES
        scripts/config --enable CONFIG_IP_NF_NAT
        scripts/config --enable CONFIG_IP_NF_FILTER
        scripts/config --enable CONFIG_IP_NF_MANGLE
        scripts/config --enable CONFIG_NETFILTER_XTABLES
        
        # 检查配置是否已应用
        echo "Checking binder configuration:"
        grep CONFIG_ANDROID_BINDER_IPC .config || echo "Binder IPC not found in config"
        
        echo "Waydroid patches applied"
    
    - name: Configure kernel
      env:
        KERNEL_SOURCE_DIR: ${{ env.KERNEL_SOURCE_DIR }}
      run: |
        cd $KERNEL_SOURCE_DIR
        echo "Configuring kernel..."
        
        # 使用现有配置作为基础
        make olddefconfig
        
        # 验证 Waydroid 相关配置
        echo "Verifying Waydroid configurations:"
        echo "CONFIG_ANDROID_BINDER_IPC: $(grep CONFIG_ANDROID_BINDER_IPC .config || echo 'NOT FOUND')"
        echo "CONFIG_ASHMEM: $(grep CONFIG_ASHMEM .config || echo 'NOT FOUND')"
        echo "CONFIG_USER_NS: $(grep CONFIG_USER_NS .config || echo 'NOT FOUND')"
    
    - name: Build kernel
      env:
        KERNEL_SOURCE_DIR: ${{ env.KERNEL_SOURCE_DIR }}
        NPROC: $(nproc)
      run: |
        cd $KERNEL_SOURCE_DIR
        echo "Building kernel with $NPROC threads..."
        
        # 编译内核
        make -j$NPROC
        
        # 编译模块
        make modules -j$NPROC
        
        echo "Kernel build completed"
    
    - name: Install modules
      env:
        KERNEL_SOURCE_DIR: ${{ env.KERNEL_SOURCE_DIR }}
      run: |
        cd $KERNEL_SOURCE_DIR
        echo "Installing modules..."
        
        # 创建临时目录安装模块
        mkdir -p kernel-modules
        make modules_install INSTALL_MOD_PATH=$(pwd)/kernel-modules
        
        echo "Modules installed"
    
    - name: Create kernel tarball
      env:
        KERNEL_SOURCE_DIR: ${{ env.KERNEL_SOURCE_DIR }}
        KERNEL_VERSION: ${{ github.event.inputs.kernel_version || '6.6.30' }}
        KERNEL_COMMIT: ${{ env.KERNEL_COMMIT }}
      run: |
        cd $KERNEL_SOURCE_DIR
        
        # 创建输出目录
        mkdir -p ../kernel-output
        
        # 复制内核映像
        cp arch/x86/boot/bzImage ../kernel-output/bzImage-waydroid
        
        # 创建版本信息文件
        cat > ../kernel-output/version-info.txt << EOF
        Kernel Version: $KERNEL_VERSION
        Commit: $KERNEL_COMMIT
        Build Date: $(date -u)
        Features: Waydroid Support (Binder, ASHMEM, Namespaces)
        Build System: GitHub Actions
        EOF
        
        # 打包模块
        tar -czf ../kernel-output/modules.tar.gz -C kernel-modules lib/modules
        
        echo "Created kernel tarball"
    
    - name: Generate WSL config file
      env:
        KERNEL_SOURCE_DIR: ${{ env.KERNEL_SOURCE_DIR }}
      run: |
        cd $KERNEL_SOURCE_DIR
        mkdir -p ../kernel-output
        
        # 生成 .wslconfig 配置文件示例
        cat > ../kernel-output/.wslconfig << 'EOF'
        # WSL2 configuration for Waydroid support
        [wsl2]
        
        # Path to the custom kernel
        kernel = C:\\path\\to\\bzImage-waydroid
        
        # Recommended settings for Waydroid
        memory = 4GB
        processors = 2
        localhostForwarding = true
        
        # Networking
        networkingMode = nat
        
        # VM options
        [vm]
        firmware = ""
        
        # Waydroid specific notes:
        # 1. Install Waydroid in Ubuntu:
        #    curl https://repo.waydro.id | bash
        #    sudo apt install waydroid
        # 
        # 2. Initialize Waydroid:
        #    sudo waydroid init
        # 
        # 3. Start Waydroid service:
        #    systemctl --user start waydroid-container
        # 
        # 4. Launch Waydroid session:
        #    waydroid session start
        EOF
        
        echo "Generated WSL config file"
    
    - name: Upload kernel artifacts
      uses: actions/upload-artifact@v4
      with:
        name: wsl2-waydroid-kernel
        path: |
          ${{ env.KERNEL_SOURCE_DIR }}/../kernel-output/*
        retention-days: 30
    
    - name: Create GitHub Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ${{ env.KERNEL_SOURCE_DIR }}/../kernel-output/bzImage-waydroid
          ${{ env.KERNEL_SOURCE_DIR }}/../kernel-output/modules.tar.gz
          ${{ env.KERNEL_SOURCE_DIR }}/../kernel-output/version-info.txt
          ${{ env.KERNEL_SOURCE_DIR }}/../kernel-output/.wslconfig
        draft: false
        prerelease: false
        generate_release_notes: true
    
    - name: Summary
      run: |
        echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "✅ WSL2 Kernel with Waydroid support built successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Artifacts include:**" >> $GITHUB_STEP_SUMMARY
        echo "- `bzImage-waydroid`: Custom kernel image" >> $GITHUB_STEP_SUMMARY
        echo "- `modules.tar.gz`: Kernel modules" >> $GITHUB_STEP_SUMMARY
        echo "- `version-info.txt`: Build information" >> $GITHUB_STEP_SUMMARY
        echo "- `.wslconfig`: Sample WSL configuration" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Usage instructions:**" >> $GITHUB_STEP_SUMMARY
        echo "1. Download the artifacts" >> $GITHUB_STEP_SUMMARY
        echo "2. Place `bzImage-waydroid` in a Windows directory" >> $GITHUB_STEP_SUMMARY
        echo "3. Update your `.wslconfig` to point to the kernel" >> $GITHUB_STEP_SUMMARY
        echo "4. Restart WSL: `wsl --shutdown`" >> $GITHUB_STEP_SUMMARY
